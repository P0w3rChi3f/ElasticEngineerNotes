# Logstash

## Logstash Install
```
yum install Logstash
```

## Options Logstash Configs
```
vi /etc/Logstash/jvm.options
6 -Xms1g
7 -Xmx1g
```

```
vi /etc/Logstash/Logstash.yml
```

## Pipeline Configuration
```
cd /etc/logstash//conf.d/
vi 100-input-zeek.conf
```

### 100-input-zeek.conf
```
input {
  kafka{
    add_field => { "[@metadata][stage]" => "zeek_raw" }
    topics => ["zeek-raw"]
    bootstrap_servers => "172.16.90.100:9092
    # set this to one per kafka partition to scale up 
    # consumer_threads => 4
    group_id => "bro_logstash"
    codec => json
    auto_offset_reset => "earliest"
  }
}
```

```
cd /etc/logstash//conf.d/
vi 500-filter-zeek.conf
```

```
filter {


}
```

```
cd /etc/logstash/conf.d/
vi 999-output-zeek.conf
```
```
output{
    if[@metadata][stage] == "zeek-raw" {
        elasticsearh {
            hosts => ["172.16.90.100:9200"]
            index => "zeek-%{+YYYY.MM.dd}"
            template => "/etc/logstash/bro-index-template.json"
        
        }
    }
}
```

## Test the status of logstash
'''
systemctl start logstash
systemctl status logstash
tail -f /var/log/logstash/logstash-plain.log
curl 172.16.90.100:9200

```

## Config Zeek Index Templates
```
http://172.16.40.100:5601/ - Settings - Management - index patterns - zeek-* - @timestamp
```
```
Index management - click index zeek-2020.01.14 - mappings - copy everything into clipboard
```
/https://github.com/rocknsm/rock-dashboards/blob/master/configuration/elasticsearch/bro_index.json
```
sudo vi /etc/logstash/bro-index-template.json

```
"id": {  
    "properties": {  
        "orig_h": {  
        "type": "ip",  
        ~~~"fields": {~~~  
        ~~~ "keyword": {~~~  
        ~~~"type": "keyword",~~~  
        ~~~"ignore_above": 256~~~  
        ~~~}~~~  
                }  
            }
        },  
        "resp_h": {  
            "type": "ip",  
            ~~~ "fields": { ~~~ 
            ~~~"keyword": { ~~~ 
            ~~~"type": "keyword", ~~~ 
            ~~~"ignore_above": 256 ~~~
           ~~~ }  ~~~
        ~~~} ~~~ 
        },  
```
```
sudo systemctl stop logstash
Kibana - index management - select index - manage index - delete index
sudo vi /etc/logstash/conf.d/900-output-zeek.conf
template => "/etc/logstash/bro-index-template.json"		//uncomment
sudo systemctl start logstash
Kibana - index management - Ctrl+F: orig_h
```

```
sudo systemctl stop logstash
Kibana - index management - select index - manage index - delete index
Kibana - Dev Tools
```
```
PUT _template/zeek_index_mapings
{
    "order": 10,
    "index_patterns": [
        "zeek-*"
    ]
```

#### Test Index File
```
GET _cat/templates
GET _template/zeek_index_mappings
```